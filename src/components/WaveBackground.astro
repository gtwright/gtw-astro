---
interface Props {
  /** Optional extra classes on the root section. */
  class?: string;
  /** Toggle all SVG/CSS animations on/off. Defaults to true. */
  animated?: boolean;
  /** Accent used to derive thread/pulse colors (CSS color). */
  accent?: string;
  /** Background color behind the SVG (CSS color). */
  background?: string;
  /** Haze/glow color behind the threads (CSS color). */
  haze?: string;
  /** Pulse “core” color (CSS color). */
  pulseCore?: string;
  /**
   * Optional inline style string.
   * Useful for overriding CSS variables, e.g.:
   * style="--waves-accent: var(--color-accent-interactive); --waves-bg: var(--color-text);"
   */
  style?: string;
  /** Optional min-height utility classes for the root section. */
  minHeightClass?: string;
}

const {
  class: className,
  animated = true,
  accent,
  background,
  haze,
  pulseCore,
  style,
  minHeightClass = 'min-h-[calc(100svh-4.5rem)]',
} = Astro.props;

const isAnimated = animated !== false;

const styleParts = [
  style,
  accent ? `--waves-accent: ${accent}` : undefined,
  background ? `--waves-bg: ${background}` : undefined,
  haze ? `--waves-haze: ${haze}` : undefined,
  pulseCore ? `--waves-pulse-core: ${pulseCore}` : undefined,
].filter(Boolean);

const mergedStyle = styleParts.length ? styleParts.join('; ') : undefined;
---

<section
  class:list={[
    'wave-background relative overflow-hidden',
    isAnimated ? 'wave-background--animated' : 'wave-background--static',
    minHeightClass,
    className,
  ]}
  style={mergedStyle}
  transition:persist
>
  <div class="absolute inset-0 wave-background__bg">
    <div class="absolute inset-0">
      <svg
        class="absolute inset-0 w-full h-full"
        viewBox="0 0 1200 800"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        preserveAspectRatio="xMidYMid slice"
        aria-hidden="true"
        focusable="false"
      >
        <defs>
          <radialGradient id="neonPulse1" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="var(--waves-pulse-core)" stop-opacity="1" />
            <stop offset="30%" stop-color="var(--waves-pulse-1)" stop-opacity="1" />
            <stop offset="70%" stop-color="var(--waves-pulse-1)" stop-opacity="0.75" />
            <stop offset="100%" stop-color="var(--waves-pulse-1)" stop-opacity="0" />
          </radialGradient>
          <radialGradient id="neonPulse2" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="var(--waves-pulse-core)" stop-opacity="0.95" />
            <stop offset="25%" stop-color="var(--waves-pulse-2)" stop-opacity="0.95" />
            <stop offset="60%" stop-color="var(--waves-pulse-2)" stop-opacity="0.7" />
            <stop offset="100%" stop-color="var(--waves-pulse-2)" stop-opacity="0" />
          </radialGradient>
          <radialGradient id="neonPulse3" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="var(--waves-pulse-core)" stop-opacity="1" />
            <stop offset="35%" stop-color="var(--waves-pulse-3)" stop-opacity="1" />
            <stop offset="75%" stop-color="var(--waves-pulse-3)" stop-opacity="0.6" />
            <stop offset="100%" stop-color="var(--waves-pulse-3)" stop-opacity="0" />
          </radialGradient>

          <radialGradient id="heroTextBg" cx="30%" cy="50%" r="70%">
            <stop offset="0%" stop-color="var(--waves-haze)" stop-opacity="0.18" />
            <stop offset="40%" stop-color="var(--waves-haze)" stop-opacity="0.1" />
            <stop offset="80%" stop-color="var(--waves-haze)" stop-opacity="0.06" />
            <stop offset="100%" stop-color="var(--waves-haze)" stop-opacity="0" />
          </radialGradient>
          <filter id="heroTextBlur" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="12" result="blur" />
            <feTurbulence baseFrequency="0.7" numOctaves="4" result="noise" />
            <feColorMatrix in="noise" type="saturate" values="0" result="monoNoise" />
            <feComponentTransfer in="monoNoise" result="alphaAdjustedNoise">
              <feFuncA type="discrete" tableValues="0.03 0.06 0.09 0.12" />
            </feComponentTransfer>
            <feComposite in="blur" in2="alphaAdjustedNoise" operator="multiply" result="noisyBlur" />
            <feMerge>
              <feMergeNode in="noisyBlur" />
            </feMerge>
          </filter>

          <linearGradient id="threadFade1" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="var(--waves-bg)" stop-opacity="1" />
            <stop offset="15%" stop-color="var(--waves-thread-1)" stop-opacity="0.85" />
            <stop offset="85%" stop-color="var(--waves-thread-1)" stop-opacity="0.85" />
            <stop offset="100%" stop-color="var(--waves-bg)" stop-opacity="1" />
          </linearGradient>
          <linearGradient id="threadFade2" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="var(--waves-bg)" stop-opacity="1" />
            <stop offset="12%" stop-color="var(--waves-thread-2)" stop-opacity="0.75" />
            <stop offset="88%" stop-color="var(--waves-thread-2)" stop-opacity="0.75" />
            <stop offset="100%" stop-color="var(--waves-bg)" stop-opacity="1" />
          </linearGradient>
          <linearGradient id="threadFade3" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="var(--waves-bg)" stop-opacity="1" />
            <stop offset="18%" stop-color="var(--waves-thread-3)" stop-opacity="0.82" />
            <stop offset="82%" stop-color="var(--waves-thread-3)" stop-opacity="0.82" />
            <stop offset="100%" stop-color="var(--waves-bg)" stop-opacity="1" />
          </linearGradient>

          <filter id="neonGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="2" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>

          <!-- Reusable “focused pulse” symbols (core + halo) -->
          <g id="pulseSymbol1">
            <circle r="7" fill="url(#neonPulse1)" opacity="0.35" filter="url(#neonGlow)">
              {isAnimated && <animate attributeName="r" values="6;9;6" dur="1.2s" repeatCount="indefinite" />}
              {isAnimated && (
                <animate
                  attributeName="opacity"
                  values="0.18;0.55;0.18"
                  dur="1.2s"
                  repeatCount="indefinite"
                />
              )}
            </circle>
            <circle r="2.2" fill="url(#neonPulse1)" opacity="0.95" filter="url(#neonGlow)">
              {isAnimated && <animate attributeName="r" values="1.8;2.6;1.8" dur="1.2s" repeatCount="indefinite" />}
              {isAnimated && (
                <animate attributeName="opacity" values="0.85;1;0.85" dur="1.2s" repeatCount="indefinite" />
              )}
            </circle>
          </g>
          <g id="pulseSymbol2">
            <circle r="8" fill="url(#neonPulse2)" opacity="0.32" filter="url(#neonGlow)">
              {isAnimated && (
                <animate attributeName="r" values="6.5;10;6.5" dur="1.35s" repeatCount="indefinite" />
              )}
              {isAnimated && (
                <animate attributeName="opacity" values="0.16;0.5;0.16" dur="1.35s" repeatCount="indefinite" />
              )}
            </circle>
            <circle r="2.6" fill="url(#neonPulse2)" opacity="0.92" filter="url(#neonGlow)">
              {isAnimated && <animate attributeName="r" values="2.2;3;2.2" dur="1.35s" repeatCount="indefinite" />}
              {isAnimated && (
                <animate attributeName="opacity" values="0.82;1;0.82" dur="1.35s" repeatCount="indefinite" />
              )}
            </circle>
          </g>
          <g id="pulseSymbol3">
            <circle r="7.5" fill="url(#neonPulse3)" opacity="0.34" filter="url(#neonGlow)">
              {isAnimated && <animate attributeName="r" values="6;9.5;6" dur="1.05s" repeatCount="indefinite" />}
              {isAnimated && (
                <animate attributeName="opacity" values="0.18;0.56;0.18" dur="1.05s" repeatCount="indefinite" />
              )}
            </circle>
            <circle r="2.3" fill="url(#neonPulse3)" opacity="0.95" filter="url(#neonGlow)">
              {isAnimated && <animate attributeName="r" values="1.9;2.8;1.9" dur="1.05s" repeatCount="indefinite" />}
              {isAnimated && (
                <animate attributeName="opacity" values="0.85;1;0.85" dur="1.05s" repeatCount="indefinite" />
              )}
            </circle>
          </g>
        </defs>

        <g>
          <ellipse cx="300" cy="350" rx="400" ry="200" fill="url(#heroTextBg)" filter="url(#heroTextBlur)" opacity="0.6" />
          <ellipse cx="350" cy="320" rx="500" ry="250" fill="url(#heroTextBg)" filter="url(#heroTextBlur)" opacity="0.4" />
          <ellipse cx="400" cy="300" rx="600" ry="300" fill="url(#heroTextBg)" filter="url(#heroTextBlur)" opacity="0.2" />

          <!-- “Music staff” threads -->
          <path
            id="thread1"
            class="wave-thread"
            style="--flow-dur: 6s; --flow-delay: -1.2s;"
            d="M50 720 Q200 590 350 540 Q500 490 650 520 Q800 550 950 460 Q1100 370 1200 340"
            stroke="url(#threadFade1)"
            stroke-width="0.8"
            fill="none"
            opacity="0.85"
          />
          {isAnimated && (
            <g class="wave-pulse pulse-1">
              <use href="#pulseSymbol1" />
              <animateMotion dur="4s" repeatCount="indefinite">
                <mpath href="#thread1" />
              </animateMotion>
            </g>
          )}

          <path
            id="thread2"
            class="wave-thread"
            style="--flow-dur: 7.2s; --flow-delay: -3.1s;"
            d="M80 730 Q250 620 400 570 Q550 520 700 550 Q850 580 1000 490 Q1150 400 1300 370"
            stroke="url(#threadFade2)"
            stroke-width="1.1"
            fill="none"
            opacity="0.75"
          />
          {isAnimated && (
            <g class="wave-pulse pulse-2">
              <use href="#pulseSymbol2" />
              <animateMotion dur="5s" repeatCount="indefinite">
                <mpath href="#thread2" />
              </animateMotion>
            </g>
          )}

          <path
            id="thread3"
            class="wave-thread"
            style="--flow-dur: 6.6s; --flow-delay: -2.2s;"
            d="M20 710 Q180 580 320 530 Q460 480 600 510 Q740 540 880 450 Q1020 360 1200 330"
            stroke="url(#threadFade3)"
            stroke-width="1.0"
            fill="none"
            opacity="0.8"
          />
          {isAnimated && (
            <g class="wave-pulse pulse-3">
              <use href="#pulseSymbol3" />
              <animateMotion dur="4.5s" repeatCount="indefinite">
                <mpath href="#thread3" />
              </animateMotion>
            </g>
          )}

          <path
            id="thread4"
            class="wave-thread"
            style="--flow-dur: 8.4s; --flow-delay: -4.4s;"
            d="M120 740 Q280 640 450 590 Q620 540 770 570 Q920 600 1070 510 Q1220 420 1350 390"
            stroke="url(#threadFade1)"
            stroke-width="0.6"
            fill="none"
            opacity="0.6"
          />
          {isAnimated && (
            <g class="wave-pulse pulse-1">
              <use href="#pulseSymbol1" />
              <animateMotion dur="5.5s" repeatCount="indefinite">
                <mpath href="#thread4" />
              </animateMotion>
            </g>
          )}

          <path
            id="thread5"
            class="wave-thread"
            style="--flow-dur: 7.8s; --flow-delay: -1.7s;"
            d="M60 725 Q220 600 380 550 Q540 500 680 530 Q820 560 960 470 Q1100 380 1280 350"
            stroke="url(#threadFade2)"
            stroke-width="0.85"
            fill="none"
            opacity="0.7"
          />
          {isAnimated && (
            <g class="wave-pulse pulse-2">
              <use href="#pulseSymbol2" />
              <animateMotion dur="4.2s" repeatCount="indefinite">
                <mpath href="#thread5" />
              </animateMotion>
            </g>
          )}
        </g>
      </svg>
    </div>
  </div>

  <div class="wave-background__content relative z-10">
    <slot />
  </div>
</section>

<style>
  /*
    Default palette.
    You can override any of these by passing `style="--waves-accent: ..."` etc.
  */
  .wave-background {
    /* Defaults align with the site's current light theme tokens. */
    --waves-bg: var(--color-main-bg, var(--color-bg));

    /* Default wave palette is atmospheric (non-interactive). */
    --waves-accent: var(--color-accent-atmosphere);
    /*
      Shade target that adapts as the global theme changes:
      - in a light theme (dark text on light bg) this becomes a slightly darker neutral
      - in a dark theme (light text on dark bg) this becomes a slightly lighter neutral
    */
    --waves-thread-shade: color-mix(in oklab, var(--waves-bg) 80%, var(--color-text) 20%);

    --waves-thread-1: color-mix(in oklab, var(--waves-accent) 88%, var(--waves-thread-shade) 12%);
    --waves-thread-2: color-mix(in oklab, var(--waves-accent) 72%, var(--waves-thread-shade) 28%);
    --waves-thread-3: color-mix(in oklab, var(--waves-accent) 60%, var(--waves-thread-shade) 40%);

    --waves-pulse-core: var(--color-surface);
    --waves-pulse-1: var(--waves-thread-2);
    --waves-pulse-2: var(--waves-thread-1);
    --waves-pulse-3: var(--waves-thread-3);

    /* Haze follows the wave accent by default. */
    --waves-haze: var(--waves-accent);
  }

  .wave-background__bg {
    background: var(--waves-bg);
  }

  /* Subtle thread shimmer */
  @keyframes wave-flow {
    0%,
    100% {
      opacity: 0.55;
    }
    50% {
      opacity: 0.95;
    }
  }

  .wave-thread {
    vector-effect: non-scaling-stroke;
    stroke-linecap: round;
    stroke-linejoin: round;
    animation: wave-flow var(--flow-dur, 17.5s) ease-in-out infinite;
    animation-delay: var(--flow-delay, 0s);
  }

  .wave-background--static .wave-thread {
    animation: none;
  }

  .wave-pulse {
    will-change: transform;
    mix-blend-mode: screen;
  }

  @media (prefers-reduced-motion: reduce) {
    .wave-thread,
    .wave-pulse,
    .wave-pulse * {
      animation: none !important;
    }
  }
</style>

