---
import type { InferGetStaticPropsType } from 'astro';
import { getCollection, render } from 'astro:content';
import Base from '../../layouts/Base.astro';
import { toTagUrl } from '../../lib/tags';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => {
    if (import.meta.env.PROD) return !data.draft && data.published <= new Date();
    return true;
  });
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post } = Astro.props as Props;
const { Content } = await render(post);

const formattedDate = post.data.published.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const allPosts = (await getCollection('posts', ({ data }) => {
    if (import.meta.env.PROD) return !data.draft && data.published <= new Date();
    return true;
  }))
  .sort((a, b) => b.data.published.valueOf() - a.data.published.valueOf());

const currentIndex = allPosts.findIndex((p) => p.id === post.id);
const prevPost = allPosts[currentIndex + 1];
const nextPost = allPosts[currentIndex - 1];
---

<Base
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  article={true}
  publishedDate={post.data.published}
  updatedDate={post.data.updated}
>
  <article class="mx-auto max-w-2xl px-6 pt-16 pb-12" transition:name={`post-${post.id}`}>
    <header class="mb-10">
      <a
        id="post-back-link"
        href="/posts"
        class="inline-flex items-center gap-2 font-(family-name:--font-ui) text-sm text-(--color-muted) no-underline hover:text-(--color-accent-interactive) transition-colors mb-6"
      >
        <span aria-hidden="true">←</span>
        <span>Back</span>
      </a>
      <div class="relative">
        {post.data.draft && (
          <span class="absolute -left-20 top-[0.6lh] -translate-y-1/2 font-(family-name:--font-ui) text-xs font-bold uppercase tracking-widest px-2.5 py-1 rounded bg-amber-400 text-amber-950 hidden lg:block">
            {post.data.draft === "placeholder" ? "Placeholder" : "Draft"}
          </span>
        )}
        <h1
          transition:name={`post-title-${post.id}`}
          class="text-3xl sm:text-4xl lg:text-5xl font-bold leading-tight tracking-tight mb-4"
        >
          {post.data.title}
        </h1>
      </div>
      <div class="flex items-center gap-3 font-(family-name:--font-ui) text-sm text-(--color-muted)">
        <time datetime={post.data.published.toISOString()}>
          {formattedDate}
        </time>
        {post.data.tags.length > 0 && (
          <>
            <span class="text-(--color-border)">·</span>
            <div class="flex gap-2">
              {post.data.tags.map((tag) => (
                <a href={toTagUrl(tag)} class="tracking-wide text-xs no-underline hover:text-(--color-accent-interactive) transition-colors">{tag}</a>
              ))}
            </div>
          </>
        )}
      </div>
    </header>

    <div class="prose">
      <Content />
    </div>

    {(prevPost || nextPost) && (
      <nav aria-label="Post pagination" class="mt-16 pt-8 border-t border-(--color-border) grid grid-cols-2 gap-8">
        {prevPost ? (
          <a href={`/posts/${prevPost.id}`} class="group no-underline">
            <span class="font-(family-name:--font-ui) text-xs text-(--color-muted) uppercase tracking-wide">Older</span>
            <p class="font-(family-name:--font-headline) text-lg font-medium mt-1 group-hover:text-(--color-accent-interactive) transition-colors m-0">
              {prevPost.data.title}
            </p>
          </a>
        ) : <div />}
        {nextPost ? (
          <a href={`/posts/${nextPost.id}`} class="group no-underline text-right">
            <span class="font-(family-name:--font-ui) text-xs text-(--color-muted) uppercase tracking-wide">Newer</span>
            <p class="font-(family-name:--font-headline) text-lg font-medium mt-1 group-hover:text-(--color-accent-interactive) transition-colors m-0">
              {nextPost.data.title}
            </p>
          </a>
        ) : <div />}
      </nav>
    )}
  </article>
</Base>
