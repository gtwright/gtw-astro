---
import type { InferGetStaticPropsType } from 'astro';
import { getCollection, render } from 'astro:content';
import Base from '../../layouts/Base.astro';
import { toTagUrl } from '../../lib/tags';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => {
    if (import.meta.env.PROD) return !data.draft;
    return true;
  });
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post } = Astro.props as Props;
const { Content } = await render(post);

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const allPosts = (await getCollection('posts', ({ data }) => {
    if (import.meta.env.PROD) return !data.draft;
    return true;
  }))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const currentIndex = allPosts.findIndex((p) => p.id === post.id);
const prevPost = allPosts[currentIndex + 1];
const nextPost = allPosts[currentIndex - 1];
---

<Base
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  article={true}
  publishedDate={post.data.date}
  updatedDate={post.data.updated}
>
  <article class="mx-auto max-w-2xl px-6 pt-16 pb-12" transition:name={`post-${post.id}`}>
    <header class="mb-12">
      <a
        id="post-back-link"
        href="/posts"
        class="link-organic inline-flex items-center gap-2 font-(family-name:--font-ui) text-sm text-(--color-muted) mb-8"
      >
        <span aria-hidden="true">&larr;</span>
        <span>All Posts</span>
      </a>
      <div class="flex items-center gap-3 font-(family-name:--font-ui) text-sm text-(--color-muted) mb-4">
        <time datetime={post.data.date.toISOString()} class="tracking-wide">
          {formattedDate}
        </time>
        {post.data.tags.length > 0 && (
          <>
            <span class="text-(--color-border)">&middot;</span>
            <div class="flex gap-2">
              {post.data.tags.map((tag) => (
                <a href={toTagUrl(tag)} class="tracking-wide text-xs no-underline hover:text-(--color-accent-interactive) transition-colors">{tag}</a>
              ))}
            </div>
          </>
        )}
      </div>
      <h1
        transition:name={`post-title-${post.id}`}
        class="text-3xl sm:text-4xl lg:text-5xl font-bold leading-[1.08] tracking-tight"
      >
        {post.data.title}
      </h1>
    </header>

    <div class="prose">
      <Content />
    </div>

    {(prevPost || nextPost) && (
      <nav class="mt-16 pt-8 grid grid-cols-2 gap-8">
        {prevPost ? (
          <a href={`/posts/${prevPost.id}`} class="group no-underline">
            <span class="font-(family-name:--font-ui) text-xs text-(--color-muted) uppercase tracking-widest">Older</span>
            <p class="font-(family-name:--font-headline) text-lg font-medium mt-2 group-hover:text-(--color-accent-interactive) transition-colors duration-300 m-0 leading-snug">
              {prevPost.data.title}
            </p>
          </a>
        ) : <div />}
        {nextPost ? (
          <a href={`/posts/${nextPost.id}`} class="group no-underline text-right">
            <span class="font-(family-name:--font-ui) text-xs text-(--color-muted) uppercase tracking-widest">Newer</span>
            <p class="font-(family-name:--font-headline) text-lg font-medium mt-2 group-hover:text-(--color-accent-interactive) transition-colors duration-300 m-0 leading-snug">
              {nextPost.data.title}
            </p>
          </a>
        ) : <div />}
      </nav>
    )}
  </article>
</Base>
