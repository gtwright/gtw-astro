---
import { getCollection, getEntry } from 'astro:content';
import { SITE } from '../../consts';
import Base from '../../layouts/Base.astro';
import PostCard from '../../components/PostCard.astro';
import { toSlug } from '../../lib/tags';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => {
    if (import.meta.env.PROD) return !data.draft && data.published <= new Date();
    return true;
  });

  const tagMap = new Map<string, { displayName: string; posts: typeof posts }>();
  for (const post of posts) {
    for (const tag of post.data.tags) {
      const slug = toSlug(tag);
      const existing = tagMap.get(slug) ?? { displayName: tag, posts: [] };
      existing.posts.push(post);
      tagMap.set(slug, existing);
    }
  }

  return [...tagMap.entries()].map(([slug, { displayName, posts }]) => ({
    params: { tag: slug },
    props: {
      displayName,
      slug,
      posts: posts.sort((a, b) => b.data.published.valueOf() - a.data.published.valueOf()),
    },
  }));
}

const { displayName, slug, posts } = Astro.props;
const tagEntry = await getEntry('tags', slug);
const description = tagEntry?.data.description;
---

<Base title={`Posts tagged "${displayName}"`} description={description ?? `All posts tagged "${displayName}" on ${SITE.title}.`}>
  <div class="mx-auto max-w-3xl px-6 pt-16 pb-12">
    <header class="mb-12">
      <a
        href="/tags"
        class="inline-flex items-center gap-2 font-(family-name:--font-ui) text-sm text-(--color-muted) no-underline hover:text-(--color-accent-interactive) transition-colors mb-6"
      >
        <span aria-hidden="true">&larr;</span>
        <span>All Tags</span>
      </a>
      <h1 class="text-4xl sm:text-5xl font-bold leading-tight tracking-tight mb-4">
        {displayName}
      </h1>
      {description && (
        <p class="font-(family-name:--font-body) text-base text-(--color-muted) leading-relaxed mb-4">
          {description}
        </p>
      )}
      <p class="font-(family-name:--font-ui) text-sm text-(--color-muted)">
        {posts.length} {posts.length === 1 ? 'article' : 'articles'}
      </p>
    </header>

    <div class="divide-y divide-(--color-border)">
      {posts.map((post) => (
        <PostCard
          title={post.data.title}
          description={post.data.description}
          published={post.data.published}
          slug={post.id}
          tags={post.data.tags}
        />
      ))}
    </div>
  </div>
</Base>
